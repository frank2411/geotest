<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Document</title>

    <style type="text/css">
      html, body { height: 100%; margin: 0; padding: 0; }
      #map { width:500px; height: 500px; }
    </style>

</head>
<body>

    <div id="map"></div>
    <script type="text/javascript">
        var terrains = {{terrains|safe}};
        var map;
        var markers = [];
        var infowindows = [];


        function closeInfos(){
          if(infowindows.length > 0){
            infowindows[0].set("marker", null);
            infowindows[0].close();
            infowindows.length = 0;
          }
        }

        function addInfoWindow(marker, data, index) {
            var infowindow = new google.maps.InfoWindow({
                content: "ECCOLOOOO"
            });

            infowindows.push(infowindow)
            console.log(infowindows[index])

            marker.addListener('click', function() {
                closeInfos();
                infowindows[0] = infowindow
                infowindow.open(marker.get('map'), marker);
            });

        }

        function addMarkers(map){

            for (terrain in terrains) {
                var obj = terrains[terrain];
                var latLng = new google.maps.LatLng(obj.fields.latitude, obj.fields.longitude);
                var marker = new google.maps.Marker({
                    position: latLng,
                    map: map,
                });

                markers.push(marker);
                addInfoWindow(marker, obj.fields)
                map.panTo(latLng)
            }

        }

        function initMap() {
          map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: -34.397, lng: 150.644},
            zoom: 15
          });

          addMarkers(map)

        }

    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCYVdMO9KjlIwe7pir9347_QFID59qDv3I&callback=initMap"></script>

</body>
</html>


